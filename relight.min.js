function Relight(b,a){if(!b)return null;this.options=Object.assign({layout:"image",visible:!0,light:[0,0,1],pos:{x:0,y:0,z:0,t:0},background:[0,0,0,0],bounded:!0,border:1,maxRequested:4,fit:!0,suffix:".jpg"},a);"string"==typeof b&&(b=document.querySelector(b));if("CANVAS"!=b.tagName)return null;this.canvas=b;var c={antialias:!1,depth:!1};this.gl=a.gl||this.canvas.getContext("webgl2",c)||this.canvas.getContext("webgl",c)||this.canvas.getContext("experimental-webgl",c);if(!this.gl)return null;this.url&&
this.url.endsWidth("/")&&(this.url=r.url.slice(0,-1));for(var e in this.options)this[e]=this.options[e];this.previous={x:0,y:0,z:0,t:0};this.previousbox=[1,1,-1,-1];this.nodes=[];this.lweights=[];this.cache={};this.queued=[];this.requested={};this.requestedCount=0;this.animaterequest=null;this.waiting=1;this.onlightchange=this.onposchange=this.onload=null;this.initGL();this.url&&this.setUrl(this.url);return this}
Relight.prototype={get:function(b,a,c){if(!b)throw"Missing url!";var e=new XMLHttpRequest;e.open("GET",b);"xml"!=a&&(e.responseType=a);e.onload=function(b){4===e.readyState&&(200===e.status?"xml"==a?c(e.responseXML):c(e.response):console.error(e.statusText))};e.send()},setUrl:function(b){var a=this;a.url=b;a.waiting=1;a.get(b+"/info.json","json",function(b){a.waiting--;a.loadInfo(b)})},loadInfo:function(b){var a=this;a.type=b.type;a.colorspace=b.colorspace;a.nmaterials=b.materials.length;a.nplanes=
b.nplanes;a.materials=b.materials;if(b.lights){a.lights=new Float32Array(b.lights.length);for(var c=0;c<a.lights.length;c++)a.lights[c]=b.lights[c]}"rbf"==a.type&&(a.sigma=b.sigma,a.ndimensions=a.lights.length/3);"bilinear"==a.type&&(a.resolution=b.resolution,a.ndimensions=a.resolution*a.resolution);"mycc"==a.colorspace?(a.yccplanes=b.yccplanes,a.nplanes=a.yccplanes[0]+a.yccplanes[1]+a.yccplanes[2]):a.yccplanes=[0,0,0];a.width=parseInt(b.width);a.height=parseInt(b.height);a.planes=[];a.scale=new Float32Array((a.nplanes+
1)*a.nmaterials);a.bias=new Float32Array((a.nplanes+1)*a.nmaterials);for(c=0;c<a.nmaterials;c++)for(var e=1;e<a.nplanes+1;e++)a.scale[c*(a.nplanes+1)+e]=a.materials[c].scale[e-1],a.bias[c*(a.nplanes+1)+e]=a.materials[c].bias[e-1];for(a.njpegs=0;3*a.njpegs<a.nplanes;)a.njpegs++;a.pos.x=a.width/2;a.pos.y=a.height/2;a.imgCache=[];for(c=0;c<a.maxRequested*a.njpegs;c++)e=new Image,e.crossOrigin="Anonymous",a.imgCache[c]=e;a.currImgCache=0;a.initTree();a.loadProgram();if("mrgb"==a.colorspace||"mycc"==a.colorspace)b.basis?
a.loadBasis(b.basis):(a.waiting++,a.get(a.url+"/materials.bin","arraybuffer",function(b){a.waiting--;a.loadBasis(b);a.loaded()}));a.loaded()},loaded:function(){if(!this.waiting){this.fit&&this.centerAndScale();if(this.onLoad)this.onLoad(this);this.computeLightWeights(this.light);this.prefetch();this.preload();this.redraw()}},initTree:function(){function b(){a.qbox=[];a.bbox=[];for(var b=a.width,c=a.height,g=0,d=a.nlevels-1;0<=d;d--){var h=a.nlevels-1-d;a.qbox[h]=[0,0,0,0];a.bbox[h]=[0,0,b,c];for(var k=
0;k*a.tilesize<c;k++){a.qbox[h][3]=k+1;for(var l=0;l*a.tilesize<b;l++)a.nodes[g++]={tex:[],missing:a.njpegs},a.qbox[h][2]=l+1}b>>>=1;c>>>=1}}var a=this;a.nodes=[];switch(a.layout){case "image":a.nlevels=1;a.tilesize=0;a.qbox=[[0,0,1,1]];a.bbox=[[0,0,a.width,a.height]];a.getTileURL=function(b,c,g,d){return a.url+"/"+b};a.nodes[0]={tex:[],missing:a.njpegs};return;case "google":a.tilesize=256;a.overlap=0;var c=Math.max(a.width,a.height)/a.tilesize;a.nlevels=Math.ceil(Math.log(c)/Math.LN2)+1;a.getTileURL=
function(b,c,g,d){b=b.substr(0,b.lastIndexOf("."));b=a.url+"/"+b;d=parseInt(a.nlevels-1-d);return b+"/"+d+"/"+g+"/"+c+a.suffix};break;case "deepzoom":a.metaDataURL=a.url+"/plane_0.dzi";a.getTileURL=function(b,c,g,d){b=b.substr(0,b.lastIndexOf("."));b=a.url+"/"+b+"_files/";d=parseInt(a.nlevels-1-d);return b+d+"/"+c+"_"+g+a.suffix};a.parseMetaData=function(b){a.suffix="."+/Format="(\w+)/.exec(b)[1];a.tilesize=parseInt(/TileSize="(\d+)/.exec(b)[1]);a.overlap=parseInt(/Overlap="(\d+)/.exec(b)[1]);b=Math.max(a.width,
a.height)/a.tilesize;a.nlevels=Math.ceil(Math.log(b)/Math.LN2)+1};break;case "zoomify":a.overlap=0;a.metaDataURL=a.url+"/plane_0/ImageProperties.xml";a.getTileURL=function(b,c,g,d){b=b.substr(0,b.lastIndexOf("."));b=a.url+"/"+b;var h=parseInt(a.nlevels-1-d);d=a.index(d,c,g)>>>0>>8;return b+"/TileGroup"+d+"/"+h+"-"+c+"-"+g+a.suffix};a.parseMetaData=function(b){b=b.split('"');a.tilesize=parseInt(b[11]);b=Math.max(a.width,a.height)/a.tilesize;a.nlevels=Math.ceil(Math.log(b)/Math.LN2)+1};break;case "iip":a.suffix=
".tif";a.overlap=0;a.metaDataURL=a.server+"?FIF="+a.path+"/plane_0"+a.suffix+"&obj=IIP,1.0&obj=Max-size&obj=Tile-size&obj=Resolution-number";a.parseMetaData=function(b){var c=b.split("Tile-size:");if(!c[1])return null;a.tilesize=parseInt(c[1].split(" ")[0]);a.nlevels=parseInt(b.split("Resolution-number:")[1])};a.getTileURL=function(b,c,g,d){b=b.substr(0,b.lastIndexOf("."));b=a.path+"/"+b+a.suffix;c=g*a.qbox[d][2]+c;d=parseInt(a.nlevels-1-d);return a.server+"?FIF="+b+"&JTL="+d+","+c};break;default:console.log("OOOPPpppps")}a.metaDataURL?
(a.waiting++,a.get(a.metaDataURL,"text",function(c){a.waiting--;a.parseMetaData(c);b();a.loaded()})):b()},resize:function(b,a){this.canvas.width=b;this.canvas.height=a;this.prefetch();this.redraw()},zoom:function(b,a){var c=this.pos;this.setPosition(c.x,c.y,c.z+b,a)},center:function(b){this.setPosition(this.width/2,this.height/2,this.pos.z,b)},centerAndScale:function(b){var a=Math.max(this.width/this.canvas.width,this.height/this.canvas.height),a=Math.log(a)/Math.LN2;this.setPosition(this.width/2,
this.height/2,a,b)},pan:function(b,a,c){var e=this.pos,f=Math.pow(2,e.z);this.setPosition(e.x-b*f,e.y-a*f,e.z,c)},setPosition:function(b,a,c,e){var f=Math.pow(2,c);if(this.bounded&&this.width){f=Math.min(c,Math.log(this.width/this.canvas.width)/Math.log(2));c=Math.min(c,Math.log(this.height/this.canvas.height)/Math.log(2));c=Math.max(f,c);var f=Math.pow(2,c),g=[f*this.canvas.width/2,this.width-f*this.canvas.width/2].sort(function(a,b){return a-b});b=Math.max(g[0],Math.min(g[1],b));f=[f*this.canvas.height/
2,this.height-f*this.canvas.height/2].sort(function(a,b){return a-b});a=Math.max(f[0],Math.min(f[1],a));-1>=c&&(c=-1)}e||(e=0);f=performance.now();this.previous=this.getCurrent(f);b==this.previous.x&&a==this.previous.y&&c==this.previous.z||(this.pos={x:b,y:a,z:c,t:f+e},this.prefetch(),this.redraw())},getCurrent:function(b){if(b>this.pos.t)return{x:this.pos.x,y:this.pos.y,z:this.pos.z,t:b};var a=this.pos.t-this.previous.t;if(1>a)return this.pos;var a=(this.pos.t-b)/(this.pos.t-this.previous.t),c=1-
a;return{x:this.pos.x*c+this.previous.x*a,y:this.pos.y*c+this.previous.y*a,z:this.pos.z*c+this.previous.z*a,t:b}},initGL:function(){var b=this.gl;b.pixelStorei(b.UNPACK_COLORSPACE_CONVERSION_WEBGL,b.NONE);var a=this.options.background;b.clearColor(a[0],a[1],a[2],a[3],a[4]);b.disable(b.DEPTH_TEST);b.clear(b.COLOR_BUFFER_BIT);b.viewport(0,0,this.canvas.width,this.canvas.height)},basePixelOffset:function(b,a,c,e,f){return 3*((b*(this.nplanes+1)+a)*this.resolution*this.resolution+(c+e*this.resolution))+
f},baseLightOffset:function(b,a,c,e){return 3*((b*(this.nplanes+1)+a)*this.ndimensions+c)+e},loadBasis:function(b){b=new Uint8Array(b);this.basis=new Float32Array(b.length);for(var a=0;a<this.nmaterials;a++)for(var c=0;c<this.nplanes+1;c++)for(var e=0;e<this.ndimensions;e++)for(var f=0;3>f;f++){var g=this.baseLightOffset(a,c,e,f);this.basis[g]=0==c?b[g]/255:(b[g]-127)/this.materials[a].range[c-1]}},index:function(b,a,c){for(var e=0,f=this.nlevels-1;f>b;f--)e+=this.qbox[f][2]*this.qbox[f][3];return e+
c*this.qbox[b][2]+a},loadTile:function(b,a,c){var e=this.index(b,a,c);if(this.requested[e])console.log("AAARRGGHHH double request!");else{this.requested[e]=!0;this.requestedCount++;for(var f=0;f<this.njpegs;f++)this.loadComponent(f,e,b,a,c)}},loadComponent:function(b,a,c,e,f){var g=this,d=g.gl,h=g.imgCache[g.currImgCache++];g.currImgCache>=g.imgCache.length&&(g.currImgCache=0);h.src=g.getTileURL("plane_"+b+".jpg",e,f,c);h.onload=function(){var c=d.createTexture();d.bindTexture(d.TEXTURE_2D,c);d.texParameterf(d.TEXTURE_2D,
d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameterf(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE);d.texImage2D(d.TEXTURE_2D,0,d.RGB,d.RGB,d.UNSIGNED_BYTE,h);g.nodes[a].tex[b]=c;g.nodes[a].missing--;0==g.nodes[a].missing&&(delete g.requested[a],g.requestedCount--,g.preload(),g.redraw())};h.onerror=function(){g.nodes[a].missing=-1;delete g.requested[a];g.requestedCount--;g.preload()}},
computeLightWeights:function(b){if(!this.waiting){switch(this.type){case "rbf":this.computeLightWeightsRbf(b);break;case "bilinear":this.computeLightWeightsOcta(b);break;case "ptm":this.computeLightWeightsPtm(b);break;case "hsh":this.computeLightWeightsHsh(b);break;default:console.log("Unknown basis",this.type)}this.baseLocation&&("mrgb"!=this.colorspace&&"mycc"!=this.colorspace?this.gl.uniform1fv(this.baseLocation,this.lweights):this.gl.uniform3fv(this.baseLocation,this.lweights))}},computeLightWeightsPtm:function(b){b=
[1,b[0],b[1],b[0]*b[0],b[0]*b[1],b[1]*b[1]];this.lweights=new Float32Array(this.nplanes);for(var a=0;a<b.length;a++)this.lweights[a]=b[a]},computeLightWeightsHsh:function(b){var a=Math.atan2(b[1],b[0]);0>a&&(a=6.283+a);var c=Math.min(Math.acos(b[2]),1.07075);b=Math.cos(a);var c=Math.cos(c),e=c*c,f=new Float32Array(9);f[0]=1/Math.sqrt(6.283);f[1]=Math.sqrt(6/3.1415)*b*Math.sqrt(c-e);f[2]=Math.sqrt(3/6.283)*(-1+2*c);f[3]=Math.sqrt(6/3.1415)*Math.sqrt(c-e)*Math.sin(a);f[4]=Math.sqrt(30/3.1415)*Math.cos(2*
a)*(-c+e);f[5]=Math.sqrt(30/3.1415)*b*(-1+2*c)*Math.sqrt(c-e);f[6]=Math.sqrt(5/6.283)*(1-6*c+6*e);f[7]=Math.sqrt(30/3.1415)*(-1+2*c)*Math.sqrt(c-e)*Math.sin(a);f[8]=Math.sqrt(30/3.1415)*(-c+e)*Math.sin(2*a);this.lweights=f},computeLightWeightsRbf:function(b){for(var a=this.nmaterials,c=this.nplanes,e=1/(this.sigma*this.sigma),f=Array(this.ndimensions),g=0,d=0;d<f.length;d++){var h=this.lights[3*d+0]-b[0],k=this.lights[3*d+1]-b[1],l=this.lights[3*d+2]-b[2],h=Math.exp(-e*(h*h+k*k+l*l));f[d]=[d,h];g+=
h}for(d=0;d<f.length;d++)f[d][1]/=g;for(d=g=b=0;d<f.length;d++)0.001<f[d][1]&&(f[b++]=f[d],g+=f[d][1]);f=f.slice(0,b);for(d=0;d<f.length;d++)f[d][1]/=g;this.lweights=new Float32Array(3*a*(c+1));for(g=0;g<a;g++)for(d=0;d<c+1;d++)for(b=0;3>b;b++)for(e=0;e<f.length;e++)h=this.baseLightOffset(g,d,f[e][0],b),this.lweights[3*(g*(c+1)+d)+b]+=f[e][1]*this.basis[h]},computeLightWeightsOcta:function(b){var a=this.nmaterials,c=this.nplanes,e=Math.abs(b[0])+Math.abs(b[1])+Math.abs(b[2]),f=(b[0]+b[1])/e,g=(b[1]-
b[0])/e,f=(f+1)/2*(this.resolution-1),g=(g+1)/2*(this.resolution-1);b=Math.min(this.resolution-2,Math.max(0,Math.floor(f)));var e=Math.min(this.resolution-2,Math.max(0,Math.floor(g))),d=f-b,h=g-e,f=(1-d)*(1-h),g=d*(1-h),k=(1-d)*h,d=d*h;this.lweights=new Float32Array(3*a*(c+1));for(h=0;h<a;h++)for(var l=0;l<c+1;l++)for(var m=0;3>m;m++){var n=this.basePixelOffset(h,l,b,e,m);this.lweights[3*(h*(c+1)+l)+m]+=f*this.basis[n];n=this.basePixelOffset(h,l,b+1,e,m);this.lweights[3*(h*(c+1)+l)+m]+=g*this.basis[n];
n=this.basePixelOffset(h,l,b,e+1,m);this.lweights[3*(h*(c+1)+l)+m]+=k*this.basis[n];n=this.basePixelOffset(h,l,b+1,e+1,m);this.lweights[3*(h*(c+1)+l)+m]+=d*this.basis[n]}},setLight:function(b,a,c){var e=Math.sqrt(b*b+a*a+c*c);this.light=[b/e,a/e,c/e];this.computeLightWeights(this.light);this.redraw()},loadProgram:function(){this.vertCode="uniform mat4 u_matrix;\n\nattribute vec4 a_position;\nvarying vec2 v_texcoord;\n\nvoid main() {\n\tgl_Position = u_matrix * a_position;\n\tv_texcoord.x = a_position.x;\n\tv_texcoord.y = a_position.y;\n}";
var b="#ifdef GL_ES\nprecision highp float;\n#endif\n\nconst int np1 = "+(this.nplanes+1)+";\nconst int nj1 = "+(this.njpegs+1)+";\nconst int nm = "+this.nmaterials+";\nconst int nmp1 = np1*nm;\nuniform sampler2D planes[nj1];      //0 is segments\nuniform vec3 base[nmp1];\nuniform float bias[nmp1];\nuniform float scale[nmp1];\n\nvarying vec2 v_texcoord;\nvoid main(void) {\n\tvec3 color = vec3(0);\n",b=1==this.nmaterials?b+"\n\tcolor += base[0];\n\tfor(int j = 1; j < nj1; j++) {\n\t\tvec4 c = texture2D(planes[j-1], v_texcoord);\n\t\tcolor += base[j*3-2]*(c.x - bias[j*3-2])*scale[j*3-2];\n\t\tcolor += base[j*3-1]*(c.y - bias[j*3-1])*scale[j*3-1];\n\t\tcolor += base[j*3-0]*(c.z - bias[j*3-0])*scale[j*3-0];\n\t};\n":
b+"\n\tint mat = int(texture2D(planes[0], v_texcoord).x*256.0)/8;\n\tfor(int m = 0; m < nm; m++)\n\t\tif(m == mat) {\n\t\t\tcolor += base[m*np1];\n\t\t\tfor(int j = 1; j < nj1; j++) {\n\t\t\t\tvec4 c = texture2D(planes[j], v_texcoord);\n\t\t\t\tcolor += base[m*np1 + j*3-2]*(c.x - bias[m*np1 + j*3-2])*scale[m*np1 + j*3-2];\n\t\t\t\tcolor += base[m*np1 + j*3-1]*(c.y - bias[m*np1 + j*3-1])*scale[m*np1 + j*3-1];\n\t\t\t\tcolor += base[m*np1 + j*3-0]*(c.z - bias[m*np1 + j*3-0])*scale[m*np1 + j*3-0];\n\t\t\t}\n\t\t}",
b=b+"\t/* gamma fix\n\tcolor.x *= color.x;\n\tcolor.y *= color.y;\n\tcolor.z *= color.z;\n\tgl_FragColor = vec4(color, 1.0);\n}\n",a="#ifdef GL_ES\nprecision highp float;\n#endif\n\nconst int ny0 = "+this.yccplanes[0]+";\nconst int ny1 = "+this.yccplanes[1]+";\n\nconst int np1 = "+(this.nplanes+1)+";\nconst int nj1 = "+(this.njpegs+1)+";\nconst int nm  = "+this.nmaterials+";\nconst int nmp1 = np1*nm;\nuniform sampler2D planes[nj1];      //0 is segments\nuniform vec3  base[nmp1];\nuniform float bias[nmp1];\nuniform float scale[nmp1];\n\nvarying vec2 v_texcoord;\nvoid main(void) { \n\tvec3 color = vec3(0);\n",
a=1==this.nmaterials?a+"\n\tcolor += base[0];\n\tfor(int j = 1; j < nj1; j++) {\n\t\tvec4 c = texture2D(planes[j-1], v_texcoord);\n\n\t\tif(j-1 < ny1) {\n\t\t\tcolor.x += base[j*3-2].x*(c.x - bias[j*3-2])*scale[j*3-2];\n\t\t\tcolor.y += base[j*3-1].y*(c.y - bias[j*3-1])*scale[j*3-1];\n\t\t\tcolor.z += base[j*3-0].z*(c.z - bias[j*3-0])*scale[j*3-0];\n\t\t} else {\n\t\t\tcolor.x += base[j*3-2].x*(c.x - bias[j*3-2])*scale[j*3-2];\n\t\t\tcolor.x += base[j*3-1].x*(c.y - bias[j*3-1])*scale[j*3-1];\n\t\t\tcolor.x += base[j*3-0].x*(c.z - bias[j*3-0])*scale[j*3-0];\n\t\t}\n\t};\n\n\tfloat tmp = color.r - color.b/2.0;\n\tvec3 rgb;\n\trgb.g = color.b + tmp;\n\trgb.b = tmp - color.g/2.0;\n\trgb.r = rgb.b + color.g;\n\tcolor = rgb;\n":
a+"\n\tint mat = int(texture2D(planes[0], v_texcoord).x*256.0)/8;\n\tfor(int m = 0; m < nm; m++)\n\t\tif(m == mat) {\n\t\t\tcolor += base[m*np1];\n\t\t\tfor(int j = 1; j < nj1; j++) {\n\t\t\t\tvec4 c = texture2D(planes[j], v_texcoord);\n\t\t\t\tcolor += base[m*np1 + j*3-2]*(c.x - bias[m*np1 + j*3-2])*scale[m*np1 + j*3-2];\n\t\t\t\tcolor += base[m*np1 + j*3-1]*(c.y - bias[m*np1 + j*3-1])*scale[m*np1 + j*3-1];\n\t\t\t\tcolor += base[m*np1 + j*3-0]*(c.z - bias[m*np1 + j*3-0])*scale[m*np1 + j*3-0];\n\t\t\t}\n\t\t}",
a=a+"\tgl_FragColor = vec4(color, 1.0);\n}",c="#ifdef GL_ES\nprecision highp float;\n#endif\n\nconst int np1 = "+(this.nplanes+1)+";\nconst int nj = "+this.njpegs+";\nuniform sampler2D planes[nj];      //0 is segments\nuniform float base[np1-3];\nuniform float bias[np1];\nuniform float scale[np1];\n\nvarying vec2 v_texcoord;\n\nvoid main(void) {\n\tvec3 color = vec3(0);\n\tfor(int j = 0; j < nj; j++) {\n\t\tvec4 c = texture2D(planes[j], v_texcoord);\n\t\tcolor.x += base[j]*(c.x - bias[j*3+1])*scale[j*3+1];\n\t\tcolor.y += base[j]*(c.y - bias[j*3+2])*scale[j*3+2];\n\t\tcolor.z += base[j]*(c.z - bias[j*3+3])*scale[j*3+3];\n\t}\n\tgl_FragColor = vec4(color, 1.0);\n}",
e="#ifdef GL_ES\nprecision highp float;\n#endif\n\nconst int np1 = "+(this.nplanes+1)+";\nconst int nj = "+this.njpegs+";\nuniform sampler2D planes[nj];      //0 is segments\nuniform float base[np1-3];\nuniform float bias[np1];\nuniform float scale[np1];\n\nvarying vec2 v_texcoord;\n\nvec3 toYcc(vec4 rgb) {\n\tvec3 c;\n\tc.x =       0.299   * rgb.x + 0.587   * rgb.y + 0.114   * rgb.z;\n\tc.y = 0.5 - 0.16874 * rgb.x - 0.33126 * rgb.y + 0.50000 * rgb.z;\n\tc.z = 0.5 + 0.50000 * rgb.x - 0.41869 * rgb.y - 0.08131 * rgb.z;\n\treturn c;\n}\n\nvec3 toRgb(vec4 ycc) {\n\tycc.y -= 0.5;\n\tycc.z -= 0.5;\n\tvec3 c;\n\tc.x = ycc.x +                   1.402   *ycc.z;\n\tc.y = ycc.x + -0.344136*ycc.y - 0.714136*ycc.z;\n\tc.z = ycc.x +  1.772   *ycc.y;\n\treturn c;\n}\n\nvoid main(void) {\n\tvec3 color = vec3(0);\n\tfor(int j = 0; j < nj; j++) {\n\t\tvec4 c = texture2D(planes[j], v_texcoord);\n\t\tcolor.x += base[j]*(c.x - bias[j*3+1])*scale[j*3+1];\n\n\t\tif(j == 0) {\n\t\t\tcolor.y = (c.y - bias[j*3+2])*scale[j*3+2];\n\t\t\tcolor.z = (c.z - bias[j*3+3])*scale[j*3+3];\n\t\t}\n\t}\n\n\tcolor = toRgb(vec4(color, 1.0));\n\tgl_FragColor = vec4(color, 1.0);\n}",
f="#ifdef GL_ES\nprecision highp float;\n#endif\n\nconst int np1 = "+(this.nplanes+1)+";\nconst int nj = "+this.njpegs+";\nuniform sampler2D planes[nj];      //0 is segments\nuniform float base[np1]; //lrgb ptm the weights starts from 0 (while bias and scale start from 3\nuniform float bias[np1];\nuniform float scale[np1];\n\nvarying vec2 v_texcoord;\n\nvoid main(void) {\n\tvec4 color = texture2D(planes[0], v_texcoord);\n\tfloat l = 0.0;\n\tfor(int j = 1; j < nj; j++) {\n\t\tvec4 c = texture2D(planes[j], v_texcoord);\n\t\tl += base[j*3-3]*(c.x - bias[j*3+1])*scale[j*3+1];\n\t\tl += base[j*3-2]*(c.y - bias[j*3+2])*scale[j*3+2];\n\t\tl += base[j*3-1]*(c.z - bias[j*3+3])*scale[j*3+3];\n\t}\n\n\tgl_FragColor = vec4(color.x*l, color.y*l, color.z*l, 1.0);\n}";
switch(this.colorspace){case "ycc":this.fragCode=e;break;case "mycc":this.fragCode=a;break;case "mrgb":this.fragCode=b;break;case "rgb":this.fragCode=c;break;case "lrgb":this.fragCode=f}b=this.gl;a=b.createShader(b.VERTEX_SHADER);b.shaderSource(a,this.vertCode);b.compileShader(a);console.log(b.getShaderInfoLog(a));c=b.createShader(b.FRAGMENT_SHADER);b.shaderSource(c,this.fragCode);b.compileShader(c);this.program=b.createProgram();b.getShaderParameter(c,b.COMPILE_STATUS)||(console.log(this.fragCode),
console.log(b.getShaderInfoLog(c)));b.attachShader(this.program,a);b.attachShader(this.program,c);b.linkProgram(this.program);b.useProgram(this.program);this.vbuffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,this.vbuffer);b.bufferData(b.ARRAY_BUFFER,new Float32Array([0,0,0,0,1,0,1,1,0,1,0,0]),b.STATIC_DRAW);this.ibuffer=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.ibuffer);b.bufferData(b.ELEMENT_ARRAY_BUFFER,new Uint16Array([3,2,1,3,1,0]),b.STATIC_DRAW);a=b.getAttribLocation(this.program,
"a_position");b.vertexAttribPointer(a,3,b.FLOAT,!1,0,0);b.enableVertexAttribArray(a);this.matrixLocation=b.getUniformLocation(this.program,"u_matrix");this.baseLocation=b.getUniformLocation(this.program,"base");this.planesLocations=b.getUniformLocation(this.program,"planes");b.uniform1fv(b.getUniformLocation(this.program,"scale"),this.scale);b.uniform1fv(b.getUniformLocation(this.program,"bias"),this.bias);a=b.getUniformLocation(this.program,"planes");c=new Int32Array(this.njpegs);for(e=c.length;e--;)c[e]=
e;b.uniform1iv(a,c)},drawNode:function(b,a,c,e,f){a=this.index(c,e,f);if(0==this.nodes[a].missing){var g=Math.pow(2,b.z);if("image"==this.layout)k=2*(this.width/g)/this.canvas.width,d=2*(this.height/g)/this.canvas.height,e=-2*(b.x/g)/this.canvas.width,b=-2*(b.y/g)/this.canvas.height;else{var d=this.tilesize*(1<<c),h=d/g,k=d;c=this.overlap*(1<<c)/g;c=[0==e?0:c,0==f?0:c,c,c];"google"!=this.layout&&(k*(e+1)>this.width&&(k=this.width-k*e,c[2]=0),d*(f+1)>this.height&&(d=this.height-d*f,c[3]=0));var k=
2*(k/g+c[0]+c[2])/this.canvas.width,d=2*(d/g+c[1]+c[3])/this.canvas.height;e=-2*(b.x/g-e*h+c[0])/this.canvas.width;b=-2*(b.y/g-f*h+c[1])/this.canvas.height}b=[k,0,0,0,0,-d,0,0,0,0,1,0,e,-b,0,1];f=this.gl;for(e=0;e<this.njpegs;e++)f.activeTexture(f.TEXTURE0+e),f.bindTexture(f.TEXTURE_2D,this.nodes[a].tex[e]);f.uniformMatrix4fv(this.matrixLocation,!1,b);f.drawElements(f.TRIANGLES,6,f.UNSIGNED_SHORT,0)}},draw:function(b){var a=this.gl;this.animaterequest=null;this.gl.viewport(0,0,this.canvas.width,this.canvas.height);
var c=this.options.background;a.clearColor(c[0],c[1],c[2],c[3],c[4]);a.clear(a.COLOR_BUFFER_BIT);a.enable(a.SCISSOR_TEST);if(!this.waiting&&this.visible){var c=this.getCurrent(performance.now()),e=this.neededBox(c,0),f=e.level,g=Math.pow(2,c.z),d=[this.canvas.width/2-c.x/g,this.canvas.height/2-(this.height-c.y)/g,this.width/g,this.height/g];"google"==this.layout&&(d[0]+=1,d[1]+=1,d[2]-=2,d[3]-=2);a.scissor(d[0],d[1],d[2],d[3]);for(var g={},d=e.box[f],h=d[1];h<d[3];h++)for(e=d[0];e<d[2];e++)for(var k=
f;k<this.nlevels;){var l=k-f,m=this.index(k,e>>l,h>>l);if(0==this.nodes[m].missing){g[m]=[k,e>>l,h>>l];break}k++}for(m in g)d=g[m],k=d[0],e=d[1],h=d[2],this.drawNode(c,f,k,e,h);b<this.pos.t&&this.redraw();a.disable(a.SCISSOR_TEST)}},redraw:function(){var b=this;b.animaterequest||(b.animaterequest=requestAnimationFrame(function(a){b.draw(a)}))},prefetch:function(){if(!this.waiting&&this.visible){var b=this.neededBox(this.pos,this.border),a=b.level,c=b.box[a];if(!(this.previouslevel==a&&c[0]==this.previousbox[0]&&
c[1]==this.previousbox[1]&&c[2]==this.previousbox[2]&&c[3]==this.previousbox[3])){this.previouslevel=a;this.previousbox=c;this.queued=[];for(var e=this.nlevels-1;e>=a;e--){for(var c=b.box[e],f=[],g=c[1];g<c[3];g++)for(var d=c[0];d<c[2];d++){var h=this.index(e,d,g);0!=this.nodes[h].missing&&!this.requested[h]&&f.push({level:e,x:d,y:g})}var k=(c[0]+c[2]-1)/2,l=(c[1]+c[3]-1)/2;f.sort(function(a,b){return Math.abs(a.x-k)+Math.abs(a.y-l)-Math.abs(b.x-k)-Math.abs(b.y-l)});this.queued=this.queued.concat(f)}this.preload()}}},
preload:function(){for(;this.requestedCount<this.maxRequested&&0<this.queued.length;){var b=this.queued.shift();this.loadTile(b.level,b.x,b.y)}},neededBox:function(b,a){if("image"==this.layout)return{level:0,box:[[0,0,1,1]]};for(var c=this.canvas.width,e=this.canvas.height,f=Math.max(0,Math.min(Math.floor(b.z),this.nlevels-1)),g=Math.pow(2,b.z),d=[],h=this.nlevels-1;h>=f;h--){var k=[b.x-g*c/2,b.y-g*e/2,b.x+g*c/2,b.y+g*e/2],l=this.tilesize*Math.pow(2,h),k=[Math.floor(k[0]/l),Math.floor(k[1]/l),Math.floor((k[2]-
1)/l)+1,Math.floor((k[3]-1)/l)+1];k[0]=Math.max(k[0]-a,this.qbox[h][0]);k[1]=Math.max(k[1]-a,this.qbox[h][1]);k[2]=Math.min(k[2]+a,this.qbox[h][2]);k[3]=Math.min(k[3]+a,this.qbox[h][3]);d[h]=k}return{level:f,box:d}}};
